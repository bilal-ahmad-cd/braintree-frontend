<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Management - Braintree</title>
    <script src="https://js.braintreegateway.com/web/dropin/1.40.2/js/dropin.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .nav-links {
            margin-top: 15px;
        }

        .nav-links a {
            color: #667eea;
            text-decoration: none;
            margin-right: 20px;
            font-weight: 600;
        }

        .nav-links a:hover {
            text-decoration: underline;
        }

        .content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .loading {
            text-align: center;
            color: #666;
            padding: 40px;
        }

        .error {
            background: #fee;
            border: 1px solid #fcc;
            color: #c33;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .customer-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .customer-table th {
            background: #f7f9fc;
            padding: 12px;
            text-align: left;
            border-bottom: 2px solid #e1e8ed;
            font-weight: 600;
            color: #333;
        }

        .customer-table td {
            padding: 12px;
            border-bottom: 1px solid #e1e8ed;
            color: #666;
        }

        .customer-table tr:hover {
            background: #f7f9fc;
        }

        .customer-id {
            font-family: 'Courier New', monospace;
            background: #f0f0f0;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }

        .button {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .button:hover:not(:disabled) {
            background: #5568d3;
        }

        .button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .button-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e1e8ed;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #333;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        #dropin-container {
            margin: 20px 0;
            min-height: 200px;
        }

        .nonce-output {
            margin-top: 20px;
            padding: 15px;
            background: #f7f9fc;
            border-radius: 6px;
            border: 1px solid #e1e8ed;
            display: none;
        }

        .nonce-output.show {
            display: block;
        }

        .nonce-value {
            font-family: 'Courier New', monospace;
            background: white;
            padding: 12px;
            border-radius: 4px;
            border: 1px solid #ddd;
            word-break: break-all;
            font-size: 13px;
            color: #333;
            margin-top: 10px;
        }

        .copy-button {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            margin-top: 10px;
        }

        .copy-button:hover {
            background: #218838;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Customer Management</h1>
            <p style="color: #666; margin-top: 5px;">View customers and generate payment nonces</p>
            <div class="nav-links">
                <a href="/">Home (Quick Nonce Generator)</a>
                <a href="/customers.html">Customers</a>
            </div>
        </div>

        <div class="content">
            <div id="loading" class="loading">Loading customers...</div>
            <div id="error" class="error" style="display: none;"></div>

            <div id="customers-container" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="color: #333;">All Customers</h2>
                    <div id="customer-count" style="color: #666;"></div>
                </div>

                <table class="customer-table">
                    <thead>
                        <tr>
                            <th>Customer ID</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Created At</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="customers-list"></tbody>
                </table>

                <div id="pagination" class="pagination"></div>
            </div>

            <div id="empty-state" class="empty-state" style="display: none;">
                <h3>No Customers Found</h3>
                <p>There are no customers in your Braintree account yet.</p>
                <p style="margin-top: 10px;">You can create customers via the API endpoint:</p>
                <code style="background: #f0f0f0; padding: 8px; display: inline-block; margin-top: 10px; border-radius: 4px;">POST /api/customer</code>
            </div>
        </div>
    </div>

    <div id="nonce-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Generate Nonce</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>

            <div id="customer-info" style="background: #f7f9fc; padding: 15px; border-radius: 6px; margin-bottom: 20px;"></div>

            <div id="dropin-loading" class="loading">Initializing payment form...</div>
            <div id="dropin-container"></div>

            <button id="generate-nonce-btn" class="button" style="display: none; width: 100%; margin-top: 20px;">
                Generate Nonce
            </button>

            <div id="nonce-output" class="nonce-output">
                <div style="font-weight: 600; margin-bottom: 8px;">Payment Nonce:</div>
                <div class="nonce-value" id="nonce-value"></div>
                <button id="copy-button" class="copy-button">Copy Nonce</button>
            </div>
        </div>
    </div>

    <script>
        let allCustomers = [];
        let currentPage = 1;
        const itemsPerPage = 10;
        let dropinInstance = null;
        let selectedCustomer = null;

        async function loadCustomers() {
            try {
                const response = await fetch('http://localhost:3010/api/customers');
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Failed to load customers');
                }

                allCustomers = data.customers;
                document.getElementById('loading').style.display = 'none';

                if (allCustomers.length === 0) {
                    document.getElementById('empty-state').style.display = 'block';
                } else {
                    document.getElementById('customers-container').style.display = 'block';
                    document.getElementById('customer-count').textContent = `Total: ${allCustomers.length} customers`;
                    renderCustomers();
                }
            } catch (error) {
                console.error('Error loading customers:', error);
                document.getElementById('loading').style.display = 'none';
                const errorEl = document.getElementById('error');
                errorEl.textContent = 'Failed to load customers: ' + error.message;
                errorEl.style.display = 'block';
            }
        }

        function renderCustomers() {
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageCustomers = allCustomers.slice(start, end);

            const tbody = document.getElementById('customers-list');
            tbody.innerHTML = '';

            pageCustomers.forEach(customer => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><span class="customer-id">${customer.id}</span></td>
                    <td>${customer.firstName || ''} ${customer.lastName || ''}</td>
                    <td>${customer.email || '-'}</td>
                    <td>${new Date(customer.createdAt).toLocaleDateString()}</td>
                    <td>
                        <button class="button button-small" onclick="openNonceGenerator('${customer.id}', '${customer.firstName || ''} ${customer.lastName || ''}', '${customer.email || ''}')">
                            Generate Nonce
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            renderPagination();
        }

        function renderPagination() {
            const totalPages = Math.ceil(allCustomers.length / itemsPerPage);
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';

            if (totalPages <= 1) return;

            const prevBtn = document.createElement('button');
            prevBtn.className = 'button button-small';
            prevBtn.textContent = 'Previous';
            prevBtn.disabled = currentPage === 1;
            prevBtn.onclick = () => {
                currentPage--;
                renderCustomers();
            };
            pagination.appendChild(prevBtn);

            const pageInfo = document.createElement('span');
            pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
            pageInfo.style.color = '#666';
            pagination.appendChild(pageInfo);

            const nextBtn = document.createElement('button');
            nextBtn.className = 'button button-small';
            nextBtn.textContent = 'Next';
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.onclick = () => {
                currentPage++;
                renderCustomers();
            };
            pagination.appendChild(nextBtn);
        }

        async function openNonceGenerator(customerId, name, email) {
            selectedCustomer = { id: customerId, name, email };

            document.getElementById('customer-info').innerHTML = `
                <div><strong>Customer:</strong> ${name}</div>
                <div><strong>Email:</strong> ${email}</div>
                <div><strong>ID:</strong> <span class="customer-id">${customerId}</span></div>
            `;

            document.getElementById('nonce-modal').classList.add('show');
            document.getElementById('dropin-loading').style.display = 'block';
            document.getElementById('generate-nonce-btn').style.display = 'none';
            document.getElementById('nonce-output').classList.remove('show');

            try {
                const response = await fetch(`http://localhost:3010/api/client-token?customerId=${customerId}`);
                const data = await response.json();

                if (!data.clientToken) {
                    throw new Error('No client token received');
                }

                if (dropinInstance) {
                    dropinInstance.teardown();
                }

                const instance = await braintree.dropin.create({
                    authorization: data.clientToken,
                    container: '#dropin-container',
                    card: {
                        cardholderName: {
                            required: false
                        }
                    }
                });

                dropinInstance = instance;
                document.getElementById('dropin-loading').style.display = 'none';
                document.getElementById('generate-nonce-btn').style.display = 'block';

            } catch (error) {
                console.error('Error initializing Braintree:', error);
                alert('Failed to initialize payment form: ' + error.message);
                closeModal();
            }
        }

        function closeModal() {
            document.getElementById('nonce-modal').classList.remove('show');
            if (dropinInstance) {
                dropinInstance.teardown();
                dropinInstance = null;
            }
        }

        document.getElementById('generate-nonce-btn').addEventListener('click', async () => {
            const button = document.getElementById('generate-nonce-btn');
            button.disabled = true;
            button.textContent = 'Generating...';

            try {
                const payload = await dropinInstance.requestPaymentMethod();

                document.getElementById('nonce-value').textContent = payload.nonce;
                document.getElementById('nonce-output').classList.add('show');

                button.textContent = 'Generate Another Nonce';
                button.disabled = false;

                console.log('Payment Nonce:', payload.nonce);
                console.log('Customer ID:', selectedCustomer.id);

            } catch (error) {
                console.error('Error generating nonce:', error);
                alert('Please enter valid payment details');
                button.textContent = 'Generate Nonce';
                button.disabled = false;
            }
        });

        document.getElementById('copy-button').addEventListener('click', () => {
            const nonceValue = document.getElementById('nonce-value').textContent;
            const button = document.getElementById('copy-button');

            navigator.clipboard.writeText(nonceValue).then(() => {
                button.textContent = 'âœ“ Copied!';
                setTimeout(() => {
                    button.textContent = 'Copy Nonce';
                }, 2000);
            });
        });

        loadCustomers();
    </script>
</body>
</html>
