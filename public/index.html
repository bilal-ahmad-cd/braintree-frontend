<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Braintree Nonce Generator</title>
    <script src="https://js.braintreegateway.com/web/dropin/1.40.2/js/dropin.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 0;
            margin: 0;
        }

        .container {
            background: white;
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
            padding: 40px;
            min-height: 100vh;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        #dropin-container {
            margin: 20px 0;
            min-height: 200px;
        }

        .button {
            background: #007bff;
            color: white;
            border: 1px solid #007bff;
            padding: 12px 24px;
            border-radius: 4px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            width: 100%;
        }

        .button:hover:not(:disabled) {
            background: #0056b3;
            border-color: #0056b3;
        }

        .button:disabled {
            background: #e0e0e0;
            border-color: #e0e0e0;
            color: #999;
            cursor: not-allowed;
        }

        .nonce-output {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #ddd;
            display: none;
        }

        .nonce-output.show {
            display: block;
        }

        .nonce-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .nonce-value {
            font-family: 'Courier New', monospace;
            background: white;
            padding: 12px;
            border-radius: 4px;
            border: 1px solid #ddd;
            word-break: break-all;
            font-size: 13px;
            color: #333;
            position: relative;
        }

        .copy-button {
            background: #28a745;
            color: white;
            border: 1px solid #28a745;
            padding: 8px 16px;
            border-radius: 2px;
            font-size: 14px;
            cursor: pointer;
            margin-top: 10px;
        }

        .copy-button:hover {
            background: #218838;
            border-color: #218838;
        }

        .copy-button.copied {
            background: #20c997;
            border-color: #20c997;
        }

        .loading {
            text-align: center;
            color: #666;
            padding: 40px;
        }

        .error {
            background: #fee;
            border: 1px solid #fcc;
            color: #c33;
            padding: 12px;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 14px;
        }

        .test-cards {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 2px;
            font-size: 13px;
        }

        .test-cards h3 {
            font-size: 14px;
            margin-bottom: 8px;
            color: #555;
        }

        .test-cards ul {
            margin-left: 20px;
            color: #666;
        }

        .test-cards li {
            margin: 4px 0;
        }

        .tabs {
            display: flex;
            gap: 0;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }

        .tab {
            padding: 12px 24px;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-bottom: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #333;
            margin-right: 4px;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab.active {
            background: white;
            color: #007bff;
            border-bottom: 2px solid white;
            margin-bottom: -1px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .info-card {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 2px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-left: 3px solid #007bff;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 2px;
            font-size: 12px;
            font-weight: 500;
            border: 1px solid;
        }

        .badge-success {
            background: #e7f5e9;
            color: #2d7a3e;
            border-color: #2d7a3e;
        }

        .badge-warning {
            background: #fff8e6;
            color: #997404;
            border-color: #997404;
        }

        .badge-info {
            background: #e7f3ff;
            color: #0056b3;
            border-color: #0056b3;
        }

        .button.refund-button {
            background: #dc3545;
            border-color: #dc3545;
        }

        .button.refund-button:hover:not(:disabled) {
            background: #c82333;
            border-color: #bd2130;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üí≥ Braintree Nonce Generator</h1>
        <p class="subtitle">Generate vaulted payment nonces for subscriptions</p>

        <div id="customer-info-loading" style="margin: 20px 0; padding: 15px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 2px; text-align: center; color: #666;">
            Loading customer information...
        </div>

        <div id="customer-info" style="margin: 20px 0; padding: 20px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 2px; display: none;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                <div>
                    <strong style="color: #555; display: block; margin-bottom: 5px;">Customer Name:</strong>
                    <span id="customer-name" style="font-size: 15px; color: #333;">-</span>
                </div>
                <div>
                    <strong style="color: #555; display: block; margin-bottom: 5px;">Email:</strong>
                    <span id="customer-email" style="font-size: 15px; color: #333;">-</span>
                </div>
            </div>
            <div style="margin-bottom: 20px;">
                <strong style="color: #555; display: block; margin-bottom: 5px;">Customer ID:</strong>
                <span id="customer-id-display" style="font-family: 'Courier New', monospace; background: #fff; padding: 6px 10px; border: 1px solid #ddd; border-radius: 2px; font-size: 13px;">Loading...</span>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="switchTab('subscriptions')">Active Subscriptions</button>
                <button class="tab" onclick="switchTab('transactions')">Transactions</button>
                <button class="tab" onclick="switchTab('payment-methods')">Payment Methods</button>
            </div>

            <div id="subscriptions-tab" class="tab-content active">
                <div id="subscription-info">Loading...</div>
            </div>

            <div id="transactions-tab" class="tab-content">
                <div id="transactions-info">Loading...</div>
            </div>

            <div id="payment-methods-tab" class="tab-content">
                <div id="payment-methods">Loading...</div>
            </div>
        </div>

        <div id="loading" class="loading">Loading Braintree...</div>
        <div id="error" class="error" style="display: none;"></div>

        <div id="dropin-container"></div>

        <button id="submit-button" class="button" style="display: none;">
            Generate Nonce
        </button>

        <div id="nonce-output" class="nonce-output">
            <div class="nonce-label">Payment Method Nonce:</div>
            <div class="nonce-value" id="nonce-value"></div>
            <button id="copy-button" class="copy-button">Copy Nonce</button>
        </div>

        <div class="test-cards">
            <h3>üß™ Test Cards (Sandbox)</h3>
            <ul>
                <li><strong>Visa:</strong> 4111 1111 1111 1111</li>
                <li><strong>Mastercard:</strong> 5555 5555 5555 4444</li>
                <li><strong>Amex:</strong> 3782 822463 10005</li>
                <li><strong>CVV:</strong> Any 3-4 digits</li>
                <li><strong>Expiry:</strong> Any future date</li>
            </ul>
        </div>
    </div>

    <script>
        let dropinInstance;
        let CUSTOMER_ID = null;

        // Fetch customer ID from config
        async function loadConfig() {
            try {
                const response = await fetch('http://localhost:3010/api/config');
                const data = await response.json();

                if (data.customerId) {
                    CUSTOMER_ID = data.customerId;
                    document.getElementById('customer-id-display').textContent = CUSTOMER_ID;
                    return CUSTOMER_ID;
                } else {
                    throw new Error('No customer ID in configuration');
                }
            } catch (error) {
                console.error('Error loading config:', error);
                document.getElementById('customer-id-display').textContent = 'Error loading';
                document.getElementById('customer-info-loading').innerHTML =
                    '<span style="color: #721c24;">‚ö†Ô∏è Could not load configuration. Check .env file.</span>';
                throw error;
            }
        }

        // Switch between tabs
        function switchTab(tabName) {
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // Add active class to selected tab
            event.target.classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');

            // Load data for the tab if needed
            if (tabName === 'transactions') {
                loadTransactions();
            }
        }

        // Load transactions
        async function loadTransactions() {
            const transactionsEl = document.getElementById('transactions-info');
            if (transactionsEl.innerHTML !== 'Loading...') return; // Already loaded

            try {
                const response = await fetch(`http://localhost:3010/api/customer/${CUSTOMER_ID}/transactions`);
                const data = await response.json();

                if (data.success && data.transactions && data.transactions.length > 0) {
                    transactionsEl.innerHTML = data.transactions.map(txn => {
                        const canRefund = txn.status === 'settled' || txn.status === 'submitted_for_settlement';
                        const isCredit = txn.type === 'credit';
                        const isSale = txn.type === 'sale';

                        // Type indicator styling
                        const typeIcon = isCredit ? '‚Üë' : '‚Üì';
                        const typeColor = isCredit ? '#28a745' : '#dc3545';
                        const typeLabel = isCredit ? 'CREDIT' : 'SALE';
                        const amountPrefix = isCredit ? '+' : '-';

                        return `
                        <div class="info-card" id="txn-${txn.id}">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; width: 50px; height: 50px; background: ${typeColor}15; border: 2px solid ${typeColor}; border-radius: 4px;">
                                        <div style="font-size: 20px; line-height: 1; color: ${typeColor};">${typeIcon}</div>
                                        <div style="font-size: 9px; font-weight: 600; color: ${typeColor}; margin-top: 2px;">${typeLabel}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 18px; font-weight: 600; color: ${typeColor};">${amountPrefix}$${txn.amount}</div>
                                        <div style="font-size: 11px; color: #999; margin-top: 2px;">${new Date(txn.createdAt).toLocaleDateString()}</div>
                                    </div>
                                </div>
                                <span class="badge ${txn.status === 'settled' ? 'badge-success' : txn.status === 'submitted_for_settlement' ? 'badge-info' : 'badge-warning'}">${txn.status}</span>
                            </div>
                            <div style="font-size: 13px; color: #666; margin-top: 10px; padding-top: 10px; border-top: 1px solid #e9ecef;">
                                <div><strong>ID:</strong> <span style="font-family: 'Courier New', monospace; font-size: 12px;">${txn.id}</span></div>
                                ${txn.cardType ? `<div><strong>Card:</strong> ${txn.cardType} ****${txn.last4}</div>` : ''}
                                <div><strong>Date:</strong> ${new Date(txn.createdAt).toLocaleString()}</div>
                            </div>
                            ${canRefund ? `
                                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd;">
                                    <button onclick="refundTransaction('${txn.id}', '${txn.amount}')" class="button refund-button" style="width: auto; padding: 6px 16px; font-size: 13px;">
                                        Refund Transaction
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                        `;
                    }).join('');
                } else {
                    transactionsEl.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">No transactions found for this customer</div>';
                }
            } catch (error) {
                console.error('Error loading transactions:', error);
                transactionsEl.innerHTML = '<div style="text-align: center; padding: 40px; color: #721c24;">Failed to load transactions</div>';
            }
        }

        // Refund transaction
        async function refundTransaction(transactionId, amount) {
            if (!confirm(`Are you sure you want to refund this transaction for $${amount}?`)) {
                return;
            }

            const button = event.target;
            button.disabled = true;
            button.textContent = 'Processing...';

            try {
                const response = await fetch(`http://localhost:3010/api/refund/${transactionId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });

                const data = await response.json();

                if (data.success) {
                    alert(`Refund successful! Transaction ${data.transaction.id} status: ${data.transaction.status}`);
                    // Reload transactions to show updated status
                    document.getElementById('transactions-info').innerHTML = 'Loading...';
                    loadTransactions();
                } else {
                    alert(`Refund failed: ${data.error}`);
                    button.disabled = false;
                    button.textContent = 'Refund Transaction';
                }
            } catch (error) {
                console.error('Error processing refund:', error);
                alert('Failed to process refund. Please try again.');
                button.disabled = false;
                button.textContent = 'Refund Transaction';
            }
        }

        // Load customer information
        async function loadCustomerInfo() {
            try {
                const response = await fetch(`http://localhost:3010/api/customer/${CUSTOMER_ID}`);
                const data = await response.json();

                if (data.success && data.customer) {
                    const customer = data.customer;

                    // Display customer name
                    const fullName = `${customer.firstName || ''} ${customer.lastName || ''}`.trim() || 'N/A';
                    document.getElementById('customer-name').textContent = fullName;

                    // Display email
                    document.getElementById('customer-email').textContent = customer.email || 'N/A';

                    // Display payment methods
                    const paymentMethodsEl = document.getElementById('payment-methods');
                    if (customer.paymentMethods && customer.paymentMethods.length > 0) {
                        paymentMethodsEl.innerHTML = customer.paymentMethods.map(pm => {
                            const type = pm.cardType || pm.constructor.name;
                            const last4 = pm.last4 ? `****${pm.last4}` : '';
                            const expiry = pm.expirationMonth && pm.expirationYear ?
                                `Expires: ${pm.expirationMonth}/${pm.expirationYear}` : '';
                            const token = pm.token || 'N/A';
                            return `<div class="info-card">
                                <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 8px;">
                                    <strong style="color: #004085; font-size: 15px;">${type} ${last4}</strong>
                                    <span class="badge badge-success" style="margin-left: 10px;">Active</span>
                                </div>
                                <div style="font-size: 13px; color: #666;">
                                    <div><strong>Token:</strong> <span style="font-family: 'Courier New', monospace; font-size: 12px;">${token}</span></div>
                                    <div><strong>${expiry}</strong></div>
                                    ${pm.cardholderName ? `<div><strong>Cardholder:</strong> ${pm.cardholderName}</div>` : ''}
                                </div>
                            </div>`;
                        }).join('');
                    } else {
                        paymentMethodsEl.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">No payment methods on file</div>';
                    }

                    // Fetch and show subscription info
                    const subscriptionEl = document.getElementById('subscription-info');
                    subscriptionEl.innerHTML = 'Loading subscription info...';

                    try {
                        const subResponse = await fetch(`http://localhost:3010/api/customer/${CUSTOMER_ID}/subscriptions`);
                        const subData = await subResponse.json();

                        if (subData.success && subData.subscriptions && subData.subscriptions.length > 0) {
                            const activeSubs = subData.subscriptions.filter(s => s.status === 'Active');
                            const allSubs = subData.subscriptions;

                            if (activeSubs.length > 0) {
                                subscriptionEl.innerHTML = activeSubs.map(sub => {
                                    // Calculate total price with addons and discounts
                                    let basePrice = parseFloat(sub.price) || 0;
                                    let addOnsTotal = 0;
                                    let discountsTotal = 0;

                                    if (sub.addOns && sub.addOns.length > 0) {
                                        addOnsTotal = sub.addOns.reduce((total, addon) => {
                                            const amount = parseFloat(addon.amount) || 0;
                                            const quantity = parseInt(addon.quantity) || 1;
                                            return total + (amount * quantity);
                                        }, 0);
                                    }

                                    if (sub.discounts && sub.discounts.length > 0) {
                                        discountsTotal = sub.discounts.reduce((total, discount) => {
                                            return total + (parseFloat(discount.amount) || 0);
                                        }, 0);
                                    }

                                    const totalPrice = basePrice + addOnsTotal - discountsTotal;

                                    const addOnsHtml = sub.addOns && sub.addOns.length > 0
                                        ? `<div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd;">
                                            <strong>Add-ons:</strong>
                                            ${sub.addOns.map(addon => {
                                                const addonAmount = parseFloat(addon.amount) || 0;
                                                const addonQty = parseInt(addon.quantity) || 1;
                                                const addonTotal = addonAmount * addonQty;
                                                return `<div style="margin-left: 15px; margin-top: 5px;">
                                                    ‚Ä¢ ${addon.name || addon.id}: $${addonAmount.toFixed(2)} ${addonQty > 1 ? `(√ó${addonQty}) = $${addonTotal.toFixed(2)}` : ''}
                                                </div>`;
                                            }).join('')}
                                        </div>`
                                        : '';

                                    const discountsHtml = sub.discounts && sub.discounts.length > 0
                                        ? `<div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd;">
                                            <strong>Discounts:</strong>
                                            ${sub.discounts.map(discount => `
                                                <div style="margin-left: 15px; margin-top: 5px;">
                                                    ‚Ä¢ ${discount.name || discount.id}: -$${parseFloat(discount.amount).toFixed(2)}
                                                </div>
                                            `).join('')}
                                        </div>`
                                        : '';

                                    const priceBreakdown = (addOnsTotal > 0 || discountsTotal > 0)
                                        ? `<div style="margin-top: 8px; font-size: 12px; color: #999;">
                                            Base: $${basePrice.toFixed(2)}${addOnsTotal > 0 ? ` + Add-ons: $${addOnsTotal.toFixed(2)}` : ''}${discountsTotal > 0 ? ` - Discounts: $${discountsTotal.toFixed(2)}` : ''}
                                        </div>`
                                        : '';

                                    return `<div class="info-card">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                            <div>
                                                <strong style="color: #004085; font-size: 15px;">$${totalPrice.toFixed(2)}/month</strong>
                                                ${priceBreakdown}
                                            </div>
                                            <span class="badge badge-success">Active</span>
                                        </div>
                                        <div style="font-size: 13px; color: #666;">
                                            <div><strong>Plan ID:</strong> ${sub.planId || 'N/A'}</div>
                                            <div><strong>Subscription ID:</strong> <span style="font-family: 'Courier New', monospace; font-size: 12px;">${sub.id}</span></div>
                                            <div><strong>Next Billing:</strong> ${sub.nextBillingDate ? new Date(sub.nextBillingDate).toLocaleDateString() : 'N/A'}</div>
                                            <div><strong>Created:</strong> ${sub.createdAt ? new Date(sub.createdAt).toLocaleDateString() : 'N/A'}</div>
                                            ${addOnsHtml}
                                            ${discountsHtml}
                                        </div>
                                    </div>`;
                                }).join('');
                            } else {
                                subscriptionEl.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;"><p><strong>No Active Subscriptions</strong></p><p style="margin-top: 10px; font-size: 14px;">' +
                                    (allSubs.length > 0 ? `${allSubs.length} inactive subscription(s) found.` : 'Ready to create subscriptions with vaulted nonces.') +
                                    '</p></div>';
                            }
                        } else {
                            if (customer.paymentMethods && customer.paymentMethods.length > 0) {
                                subscriptionEl.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;"><p><strong>No Subscriptions</strong></p><p style="margin-top: 10px; font-size: 14px;">Ready to create subscriptions with vaulted nonces.</p></div>';
                            } else {
                                subscriptionEl.innerHTML = '<div style="text-align: center; padding: 40px; color: #856404;"><p><strong>No Subscriptions</strong></p><p style="margin-top: 10px; font-size: 14px;">Add a payment method to enable subscriptions.</p></div>';
                            }
                        }
                    } catch (subError) {
                        console.error('Error fetching subscriptions:', subError);
                        subscriptionEl.innerHTML = 'Could not load subscription info. Nonces will still be vaulted.';
                    }

                    // Show customer info and hide loading
                    document.getElementById('customer-info-loading').style.display = 'none';
                    document.getElementById('customer-info').style.display = 'block';
                } else {
                    throw new Error('Customer not found');
                }
            } catch (error) {
                console.error('Error loading customer info:', error);
                document.getElementById('customer-info-loading').innerHTML =
                    '<span style="color: #721c24;">‚ö†Ô∏è Could not load customer information</span>';
            }
        }

        // Fetch client token and initialize Braintree
        async function initializeBraintree() {
            try {
                const response = await fetch(`http://localhost:3010/api/client-token?customerId=${CUSTOMER_ID}`);
                const data = await response.json();

                if (!data.clientToken) {
                    throw new Error('No client token received');
                }

                // Create Braintree Drop-in
                const instance = await braintree.dropin.create({
                    authorization: data.clientToken,
                    container: '#dropin-container',
                    card: {
                        cardholderName: {
                            required: false
                        }
                    }
                });

                dropinInstance = instance;

                // Hide loading, show button
                document.getElementById('loading').style.display = 'none';
                document.getElementById('submit-button').style.display = 'block';

            } catch (error) {
                console.error('Error initializing Braintree:', error);
                document.getElementById('loading').style.display = 'none';
                const errorEl = document.getElementById('error');
                errorEl.textContent = 'Failed to initialize Braintree. Check console and .env configuration.';
                errorEl.style.display = 'block';
            }
        }

        // Generate nonce
        document.getElementById('submit-button').addEventListener('click', async () => {
            const button = document.getElementById('submit-button');
            const nonceOutput = document.getElementById('nonce-output');
            const nonceValue = document.getElementById('nonce-value');

            button.disabled = true;
            button.textContent = 'Generating...';

            try {
                const payload = await dropinInstance.requestPaymentMethod();

                // Display the nonce
                nonceValue.textContent = payload.nonce;
                nonceOutput.classList.add('show');

                button.textContent = 'Generate Another Nonce';
                button.disabled = false;

                console.log('Payment Nonce (Vaulted):', payload.nonce);
                console.log('Customer ID:', CUSTOMER_ID);
                console.log('Full Payload:', payload);
                console.log('‚úÖ This nonce can be used for subscriptions');

            } catch (error) {
                console.error('Error generating nonce:', error);
                alert('Please enter valid payment details');
                button.textContent = 'Generate Nonce';
                button.disabled = false;
            }
        });

        // Copy nonce to clipboard
        document.getElementById('copy-button').addEventListener('click', () => {
            const nonceValue = document.getElementById('nonce-value').textContent;
            const button = document.getElementById('copy-button');

            navigator.clipboard.writeText(nonceValue).then(() => {
                button.textContent = '‚úì Copied!';
                button.classList.add('copied');

                setTimeout(() => {
                    button.textContent = 'Copy Nonce';
                    button.classList.remove('copied');
                }, 2000);
            });
        });

        // Initialize on page load
        async function init() {
            try {
                await loadConfig();
                loadCustomerInfo();
                initializeBraintree();
            } catch (error) {
                console.error('Initialization failed:', error);
            }
        }

        init();
    </script>
</body>
</html>
